---
title: "Generating the Observation Period Table"
output: 
  bookdown::html_document2:
    number_sections: true
    toc: true
    pandoc_args: ["--number-offset=1,0"]
vignette: >
  %\VignetteIndexEntry{generateObservationPeriod}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, echo = FALSE}
CDMConnector::requireEunomia()
```

# Introduction

The [`observation_period`](https://ohdsi.github.io/CommonDataModel/cdm54.html#observation_period) table is a very important table in the [OMOP CDM](https://ohdsi.github.io/CommonDataModel/) as:

*The observation_period table contains records which define spans of time during which two conditions are expected to hold: (i) Clinical Events that happened to the Person are recorded in the Event tables, and (ii) absence of records indicate such Events did not occur during this span of time.*

In general we simplify the two conditions saying that the person is in observation.

Defining `observation_period` is crucial for many studies (e.g for the incidence or prevalence studies the table is used to define the denominator population, or in survival analysis individuals are censored when they are no longer in observation) and its definition can impact the results [CITE].

For primary care or claims data the `observation_period` can easily be defined using the registration/enrollment and deregistration/disenrollment dates, but defining the `observation_period` for databases that contain only secondary or tertiary care records can be complicated. For those cases the [HERON-UK](https://heron-uk.github.io/heron-uk/) network recommends to populate the observation period table with one record per person that spans from the first record in the database (e.g. first visit in the hospital) to the first of: (1) death record of the patient, (2) censoring age (recommended 120, but can vary depending on the source data specialisation), and (3) censoring date, usually the extraction date.^[https://heron-uk.github.io/heron-uk/data_network/conventions.html#observation-period]

In this vignette we will cover how to build different definitions of the `observation_period`:

1. First record to extraction date
2. First record to last record in the data
3. In observation only while they have an ongoing visit
4. Collapse observations separated by 180 days or less
5. Censor after 180 days of no records
6. Censor after 365 days of no records
7. First record to extraction but in pediatric databases

To show how the different observation period would be defined we will consider a toy example with only 3 records of visits (in `visit_occurrence`) and 5 records of drugs (in `drug_exposure`) those records are repsented in Figure \@ref(fig:fig-example), in blue we can see the visit records and in green the drug records.

```{r fig-example, fig.cap="Representation of a synthetic patient records.", echo=FALSE}
dob <- as.Date("2003-04-19")
x <- dplyr::tibble(
  start = 5800 + c(0, 365, 800, 5, 85, 150, 365, 810, 825),
  end = start + c(90, 120, 30, 30, 60, 60, 150, 10, 65),
  colour = factor(c(rep("visit_occurrence", 3), rep("drug_exposure", 6)), levels = c("visit_occurrence", "drug_exposure"))
) |>
  dplyr::mutate(
    start = dob + start,
    end = dob + end, 
    id = dplyr::row_number(),
    y = dplyr::if_else(colour == "visit_occurrence", 1.5, 1)
  ) |>
  tidyr::pivot_longer(cols = c("start", "end"), values_to = "x")

ggplot2::ggplot(data = x, mapping = ggplot2::aes(x = x, y = y, group = id, colour = colour)) +
  ggplot2::geom_line(linewidth = 2) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    axis.title.y = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.position = "top",
    axis.line.x = ggplot2::element_blank()
  ) +
  ggplot2::scale_x_date(
    name = "Time",
    breaks = as.Date(c("2018-07-01", "2019-01-01", "2019-07-01", "2020-01-01", "2020-07-01", "2021-01-01", "2021-07-01", "2022-01-01")), 
    labels = c(dob, "2019-01-01", "2019-07-01", "2020-01-01", "2020-07-01", "2021-01-01", "2021-07-01", "2022-01-01"), 
    limits = as.Date(c("2018-07-01", "2022-01-01"))
  ) +
  ggplot2::coord_cartesian(clip = "off", ylim = c(0.5, 2)) +
  ggplot2::annotate(
    geom = "segment", 
    x = as.Date("2018-10-01") + 5 * c(1, -1), 
    xend = as.Date("2018-10-01") + 5 * c(1, -1), 
    y = 0.42 - 0.1,
    yend = 0.42 + 0.1 
  ) +
  ggplot2::geom_vline(
    xintercept = as.Date(c("2018-07-01", "2021-04-19", "2022-01-01")),
    linetype = "dashed"
  ) +
  ggplot2::geom_label(
    mapping = ggplot2::aes(x = x, y = y, label = lab),
    data = dplyr::tibble(
      x = as.Date(c("2018-07-01", "2021-04-19", "2022-01-01")),
      y = 1.25,
      lab = c("Birth date", "18th birthday", "Extraction date")
    ), 
    inherit.aes = FALSE,
    angle = 90
  )
```

In this vignette we will show examples on how to create those observation periods in Real World Synthetic Data.

# Build observation_period table in GiBleed

In this vignette we will explain how to generate the `observation_period` table from the data of an existing cdm object using the `generateObservationPeriod()` function.

To start we will use a synthetic (**GiBleed**) cdm object from the [omock](https://ohdsi.github.io/omock/) package:

```{r}
library(omock)

cdm <- mockCdmFromDataset(datasetName = "GiBleed", source = "duckdb")
cdm
```

Note the cdm is inserted in a [duckdb](https://r.duckdb.org) connection so the data is inserted in a database.

In the following sections we will cover how to create different observation periods using the **OmopConstructor** package.

## First record to end of database

```{r}
library(OmopConstructor)
cdm <- generateObservationPeriod(
  cdm = cdm,
  collapseEra = Inf,
  persistenceWindow = Inf
)

OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period), 
                                  plotType = "densityplot",
                                  variableName = "Duration in days")
```

## Min to Max Observation Period

Another option is for an observation period to span from the first record to the last record observed for each person. 

This option can cause problems towards the end of the database. 

```{r}
cdm <- generateObservationPeriod(
  cdm,
  collapseEra = Inf,
  persistenceWindow = 0
)

OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period), 
                                  plotType = "densityplot",
                                  variableName = "Duration in days")
```

## Under observation during visits only

Another option is to have people only be under observation during primary care or hospital visits. This would result in most people having multiple observation periods, with each period duration being relatively short. 

This is not a good option to use if you want to calculate incidence or prevalence, as it will result in an unreliable denominator.

```{r}
cdm <- generateObservationPeriod(
  cdm,
  collapseEra = 0,
  persistenceWindow = 0,
  recordsFrom = c("visit_occurrence")
)

p <- OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period))
p$data <- p$data |>
  dplyr::mutate(observation_period_order = dplyr::if_else(.data$observation_period_ordinal == "all", 0, as.numeric(gsub("\\D", "", .data$observation_period_ordinal))),
                observation_period_ordinal = factor(
                  .data$observation_period_ordinal,
                  levels = .data$observation_period_ordinal[order(observation_period_order)]
                ))

p
```

## Censor after 180 days of no records
```{r}
cdm <- generateObservationPeriod(
  cdm,
  collapseEra = 180,
  persistenceWindow = 180
)

p <- OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period))
p$data <- p$data |>
  dplyr::mutate(observation_period_order = dplyr::if_else(.data$observation_period_ordinal == "all", 0, as.numeric(gsub("\\D", "", .data$observation_period_ordinal))),
                observation_period_ordinal = factor(
                  .data$observation_period_ordinal,
                  levels = .data$observation_period_ordinal[order(observation_period_order)]
                ))
```
## Censor after 365 days of no records
```{r}
cdm <- generateObservationPeriod(
  cdm,
  collapseEra = 365,
  persistenceWindow = 365
)

p <- OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period))
p$data <- p$data |>
  dplyr::mutate(observation_period_order = dplyr::if_else(.data$observation_period_ordinal == "all", 0, as.numeric(gsub("\\D", "", .data$observation_period_ordinal))),
                observation_period_ordinal = factor(
                  .data$observation_period_ordinal,
                  levels = .data$observation_period_ordinal[order(observation_period_order)]
                ))
p
```
## Censor after 545 days of no records
```{r}
cdm <- generateObservationPeriod(
  cdm,
  collapseEra = 545,
  persistenceWindow = 545
)

p <- OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period))
p$data <- p$data |>
  dplyr::mutate(observation_period_order = dplyr::if_else(.data$observation_period_ordinal == "all", 0, as.numeric(gsub("\\D", "", .data$observation_period_ordinal))),
                observation_period_ordinal = factor(
                  .data$observation_period_ordinal,
                  levels = .data$observation_period_ordinal[order(observation_period_order)]
                ))
p
```
## Paediatric Databases

The function `generateObservationPeriod()` contains an argument called `censorAge`, which allows users to define the age at which a patient is no longer in observation. For example, for paediatric databases you would not expect patients to be under observation once they turn 18.

```{r}
cdm <- generateObservationPeriod(
  cdm,
  collapseEra = Inf,
  persistenceWindow = Inf,
  censorAge = 18L
)

OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period))
OmopSketch::plotObservationPeriod(OmopSketch::summariseObservationPeriod(cdm$observation_period), 
                                  plotType = "densityplot",
                                  variableName = "Duration in days")

```


# Comparison of the different definitions

# Final remarks

For database back-end cdms note the `observation_period` table is generated in the `writeSchema`. If you want to use it to generate the `observation_period` in the `cdmSchema` you will need to use the `writeSchema = cdmSchema` and have writing permissions in the `cdmSchema`.
